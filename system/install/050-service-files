#
### FILE SERVER - NFS ###
#


mkdir -p /storage/repository    # readable for all, writable only for labadmins
chown root:labadmins /storage/repository
chmod 775 /storage/repository

mkdir -p /storage/share         # readable for all, writable for file owners or labadmins
chown root:labadmins /storage/share
chmod 775 /storage/share

mkdir -p /storage/barrel        # readable and writable for all labusers
chown root:nogroup /storage/barrel
chmod 775 /storage/barrel


cat << EOF > /etc/exports
$(gislab_config_header)
/home                       *(rw,sync,no_subtree_check,no_root_squash)
/storage/repository         *(rw,sync,no_subtree_check,no_root_squash)
/storage/share              *(rw,sync,no_subtree_check,no_root_squash)
/storage/barrel             *(rw,sync,no_subtree_check,all_squash,insecure)
EOF


cat << EOF > /etc/idmapd.conf
$(gislab_config_header)
[General]
Verbosity = 0
Pipefs-Directory = /run/rpc_pipefs
Domain = gis.lab

[Mapping]
Nobody-User = nobody
Nobody-Group = nogroup
EOF


# add /mnt mount point to fstab
if [ ! -f "/etc/gislab/050-service-files.done" ]; then
	cat << EOF >> /etc/fstab
$(gislab_config_header)
/storage  /mnt  none  bind  0  0
EOF
fi

mount /mnt  # bind mount to keep the same paths on server as on client

service nfs-kernel-server restart
service idmapd restart


# vim: set syntax=sh ts=4 sts=4 sw=4 noet:
