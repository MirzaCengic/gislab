{% load staticfiles %}

<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

		<link rel="icon" type="image/png" href="{% static 'viewer/images/webgis16.png' %}"/>
		<link rel="stylesheet" type="text/css" href="{% static 'viewer/lib/ext-3.4.1/resources/css/ext-all.css' %}"/>
		<link rel="stylesheet" type="text/css" href="{% static 'viewer/lib/ext-3.4.1/resources/css/xtheme-gray.css' %}"/>
		<link rel="stylesheet" type="text/css" href="{% static 'viewer/lib/extensions/css/Spinner.css' %}" />
		<link rel="stylesheet" type="text/css" href="{% static 'viewer/webgis.css' %}"/>

		{% if debug %}
		<script type="text/javascript" src="{% static 'viewer/lib/ext-3.4.1/adapter/ext/ext-base-debug.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/ext-3.4.1/ext-all-debug.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/OpenLayers-2.13/OpenLayers.debug.js' %}"></script>
		{% else %}
		<script type="text/javascript" src="{% static 'viewer/lib/ext-3.4.1/adapter/ext/ext-base.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/ext-3.4.1/ext-all.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/OpenLayers-2.13/OpenLayers.js' %}"></script>
		{% endif %}
		<script type="text/javascript" src="{% static 'viewer/lib/extensions/Spinner.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/extensions/SpinnerField.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/GeoExt-1.1/GeoExt.js' %}"></script>

		<script type="text/javascript" src="{% static 'viewer/js/styles.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/featureinfo_panel.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/draw_action.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/control_display.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/link_list.js' %}"></script>
		{% if google %}<script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>{% endif %}

		<title id="page-title">{{ root_title }}</title>
		
		{% comment %} ##  CONFIGURATION  ## {% endcomment %}
		<script type="text/javascript">
			function main() {

				Ext.BLANK_IMAGE_URL = "{% static 'viewer/images/s.gif' %}";
				OpenLayers.DOTS_PER_INCH = {{ dpi }};
				//OpenLayers.ProxyHost = "/proxy/?url=";
				var config = {
					projection: "{{ projection }}",
					units: "{{ units }}",
					maxExtent: [{{ project_extent }}],
				};

				var mappanel_plugins = [];
				var layer = null;
				var drawings_param = null;
				var zoom_extent = OpenLayers.Bounds.fromString('{{ zoom_extent }}');
				{% if tile_resolutions %}config.tile_resolutions = [{{ tile_resolutions }}];{% endif %}

				{% if debug %}{% autoescape off %}console.log("CONFIG: {{ config }}");{% endautoescape %}{% endif %}

				// ###  LAYERS  ###
				var maplayers = [];

				// base layers
				{% if google %}
				maplayers.push(new OpenLayers.Layer.Google('Google {{ google.title }}',
					{type: google.maps.MapTypeId.{{ google }},
					mapTypeId: '{{ google }}'}));
				{% endif %}
				// seems that must be loaded after google layer
				{% if osm %}maplayers.push(new OpenLayers.Layer.OSM());{% endif %}

				// overlay layers
				{% if layers %}
				var overlays_group_layer = new OpenLayers.Layer.WMS(
					"OverlaysGroup",
					["{{ ows_url }}&DPI={{ dpi }}&TRANSPARENT=TRUE"],
					{
						layers: ["{{ layers|join:'", "' }}"].reverse(),
						transparent: true,
						format: "image/png",
					},
					{
						gutter: 0,
						isBaseLayer: false,
						buffer: 0,
						visibility: true,
						singleTile: true,
						// attribution: "",
					}
				);
				{% else %}
				var overlays_group_layer = new OpenLayers.Layer('Empty');
				{% endif %}
				maplayers.push(overlays_group_layer);

				// drawing layers
				var points_layer = new OpenLayers.Layer.Vector('Points', {styleMap: WebgisStyles.drawing_style});
				var lines_layer = new OpenLayers.Layer.Vector('Lines', {styleMap: WebgisStyles.drawing_style});
				var polygons_layer = new OpenLayers.Layer.Vector('Polygons', {styleMap: WebgisStyles.drawing_style});
				maplayers.push(points_layer);
				maplayers.push(lines_layer);
				maplayers.push(polygons_layer);

				{% if print_composers %}
				var mmToPt = 2.834708; //conversion from mm to pt
				var printCapabilities = {
					'scales':[],
					'dpis':[
						{'name': '75dpi', 'value': '75'},
						{'name': '150dpi', 'value': '150'},
						{'name': '300dpi', 'value': '300'}
					],
					'outputFormats':[
						{'name': 'pdf'},
						{'name': 'png'}
					],
					'layouts':[
					{% for print_composer in print_composers %}
						{
							name: '{{ print_composer.name }}',
							map: {
								'width': {{ print_composer.maps.0.width }}*mmToPt,
								'height': {{ print_composer.maps.0.height }}*mmToPt
							},
							rotation: true,
							labels: {% if print_composer.labels %}['{{ print_composer.labels |join:"','"}}'],{% else %}[],{% endif %}
						},
					{% endfor %}
					],
				};

				var printExtent = new GeoExt.plugins.PrintExtent({
					printProvider: new GeoExt.data.PrintProvider({
						capabilities: printCapabilities,
					})
				});
				mappanel_plugins.push(printExtent);
				{% endif %}

				// map panel
				var mappanel = new GeoExt.MapPanel({
					id: 'map-panel',
					region: 'center',
					title: '{{ root_title }}',
					collapsible: false,
					zoom: 3,
					map: {
						allOverlays: {% if osm or google %}false{% else %}true{% endif %},
						units: config.units,
						projection: new OpenLayers.Projection(config.projection),
						resolutions: config.tile_resolutions,
						maxExtent: new OpenLayers.Bounds(config.maxExtent[0], config.maxExtent[1],
							config.maxExtent[2], config.maxExtent[3]),
						controls: []
					},
					layers: maplayers,
					items: [{
						xtype: "gx_zoomslider",
						aggressive: true,
						vertical: true,
						height: 150,
						x: 17,
						y: 85,
						plugins: new GeoExt.ZoomSliderTip()
					}],
					tbar: [],
					bbar: [],
					stateId: 'map',
					plugins: mappanel_plugins
				});
				var mappanel_container = mappanel;


				var ctrl, action;
				{% if featureinfo %}
				//featureinfo panel
				var featureinfo_panel = new WebGIS.FeatureInfoPanel({
					id: 'featureinfo-panel',
					title: 'Attributes',
					map: mappanel.map,
					autoPanMapOnSelection: false,
					collapsible: true,
					collapsed: true,
					height: 200,
					split: true,
					region: 'south',
					animate: false,
				});

				var mappanel_container = new Ext.Panel({
					layout: 'border',
					region: 'center',
					items: [
						mappanel,
						featureinfo_panel
					]
				});
				{% endif %}

				// Toolbar Actions

				{% include "viewer/actions/basic.js" %}
				{% include "viewer/actions/measurement.js" %}
				{% if featureinfo %}
				{% include "viewer/actions/featureinfo.js" %}
				{% endif %}
				{% include "viewer/actions/draw.js" %}
				{% include "viewer/actions/save_history.js" %}

				{% if print_composers %}
				{% include "viewer/actions/print.js" %}
				{% endif %}

				{% if featureinfo %}
				{% include "viewer/actions/search.js" %}
				{% endif %}

				// tree node
				var layers_root = new Ext.tree.TreeNode({
					id: 'layers-tree',
					text: 'Layers',
					expanded: true,
					draggable: false
				});

				//# base layers tree
				{% if osm or google %}
				layers_root.appendChild(new GeoExt.tree.BaseLayerContainer({
					id: 'base-layers-root',
					text: 'Base Layers',
					map: mappanel.map,
					leaf: false,
					expanded: true,
					draggable: false,
					isTarget: false,
					split: true
				}));
				{% endif %}

				// overlay layers tree
				OverlaysNode = Ext.extend(GeoExt.tree.LayerNode, {
					getAllLayers: function(obj) {
						var all_layers = [];
						this.eachChild(function(node) {
							all_layers.push(node.attributes.text);
						});
						return all_layers;
					},
					getVisibleLayers: function(obj) {
						var visible_layers = [];
						this.eachChild(function(node) {
							if (node.attributes.checked) {
								visible_layers.push(node.attributes.text);
							}
						});
						return visible_layers;
					}
				});
				layers_root.appendChild(new OverlaysNode({
					id: 'overlays-root',
					text: 'Overlays',
					layer: overlays_group_layer,
					leaf: false,
					expanded: true,
					allowDrag: false,
					loader: {
						param: "LAYERS"
					},
				}));

				// layers tree
				var layer_treepanel = new Ext.tree.TreePanel({
					id: 'layers-tree-panel',
					title: 'Content',
					enableDD: false,
					root: layers_root,
					split: true,
					border: true,
					collapsible: false,
					cmargins: '0 0 0 0',
					autoScroll: true
				});

				// legend
				var layer_legend = new GeoExt.LegendPanel({
					id: 'legend-panel',
					title: 'Legend',
					map: mappanel.map,
					border: false,
					ascending: false,
					autoScroll: true,
					filter: function(record) {
						var layer = record.data.layer;
						if (layer == points_layer || layer == lines_layer || layer == polygons_layer) {
							return false;
						}
						return true;
					},
					defaults: {
						cls: 'legend-item',
						baseParams: {
							FORMAT: 'image/png',
							SYMBOLHEIGHT: '2',
							SYMBOLWIDTH: '4',
							LAYERFONTSIZE: '8',
							LAYERFONTBOLD: 'true',
							ITEMFONTSIZE: '8',
							ICONLABELSPACE: '15'
						}
					}
				});

				// properties
				var properties = new Ext.Panel({
					title: 'Properties',
					autoScroll: true,
					html: '<div class="x-panel-body-text"> \
							<p><b>Author: </b>{{ author }}</p> \
							<p><b>E-mail: </b>{{ email }}</p> \
							<p><b>Organization: </b>{{ organization }}</p> \
							<p><b>Abstract: </b>{{ abstract }}</p> \
							<p><b>WMS URL: </b>{{ ows_url }}</p></div>'
				});

				// legend and properties accordion panel
				var accordion = new Ext.TabPanel({
					activeTab: 0,
					items: [
						layer_legend,
						properties
					]
				});

				// left panel
				var left_panel = new Ext.Panel({
					region: 'west',
					width: 250,
					defaults: {
						width: '100%',
						flex: 1
					},
					layout: 'vbox',
					collapsible: true,
					layoutConfig: {
						align: 'stretch',
						pack: 'start'
					},
					items: [
						layer_treepanel,
						accordion
					]
				});

				// viewport
				var webgis = new Ext.Viewport({
					layout: "border",
					items: [
						mappanel_container,
						left_panel
					]
				});

				{% if visible_layers %}
				// set visible layers
					{% for layer in layers %}
						{% if layer.name not in visible_layers %}
				layers_root.findChild('text', '{{ layer.name }}', true).ui.toggleCheck(false);
						{% endif %}
					{% endfor %}
				{% endif %}

				// controls
				var coords = new GeoExt.Toolbar.ControlDisplay({control: new OpenLayers.Control.MousePosition({separator: ' , '}), map: mappanel.map});

				mappanel.getBottomToolbar().add(new Ext.Toolbar.TextItem({text: config.projection}));
				mappanel.getBottomToolbar().add(' ', '-', '');
				mappanel.getBottomToolbar().add(coords);
				var measurement_output = new Ext.Toolbar.TextItem({
					id:'measurement-info',
					text: ''
				});
				mappanel.getBottomToolbar().add(' ', '-', ' ', measurement_output);

				var geojson_links = new WebGIS.Toolbar.LinkList({
					id: 'geojson-links',
					textBefore: 'Drawings: ',
				});
				mappanel.getBottomToolbar().add('->', geojson_links);

				mappanel.map.zoomToExtent(zoom_extent, true);
				mappanel.map.addControl(new OpenLayers.Control.Scale());
				mappanel.map.addControl(new OpenLayers.Control.ScaleLine());
				mappanel.map.addControl(new OpenLayers.Control.PanPanel());
				mappanel.map.addControl(new OpenLayers.Control.ZoomPanel());
				mappanel.map.addControl(new OpenLayers.Control.Navigation());
				mappanel.map.addControl(new OpenLayers.Control.Attribution());
				map = mappanel.map;

				// insert points from GET parameter
				{% if drawings %}
				var drawings_links = [];
				drawings_param = '{{ drawings|join:"," }}';
					{% for drawing_id in drawings %}
				drawings_links.push({
					hyperlink_text: '{{ drawing_id }}',
					href: Ext.urlAppend('{% url "webgis.storage.views.ball" %}', Ext.urlEncode({ID: '{{ drawing_id }}'})),
				});
				Ext.Ajax.request({
					method: 'GET',
					url: '{% url "webgis.storage.views.ball" %}',
					params: {
						ID: '{{ drawing_id }}'
					},
					success: function(response) {
						var features = new OpenLayers.Format.GeoJSON().read(response.responseText);
						var points = [];
						var lines = [];
						var polygons = [];
						Ext.each(features, function(f) {
							if (f.geometry.CLASS_NAME == 'OpenLayers.Geometry.Point')
								points.push(f);
							if (f.geometry.CLASS_NAME == 'OpenLayers.Geometry.LineString')
								lines.push(f);
							if (f.geometry.CLASS_NAME == 'OpenLayers.Geometry.Polygon')
								polygons.push(f);
						});
						points_layer.addFeatures(points);
						lines_layer.addFeatures(lines);
						polygons_layer.addFeatures(polygons);

						// parse metadata
						var metadata = JSON.parse(response.responseText).metadata;
						Ext.each(drawings_links, function(link) {
							if (link.hyperlink_text == '{{ drawing_id }}') {
								link.name = metadata.title;
								geojson_links.setLinks(drawings_links);
							}
						})
					},
					failure: function(response, opts) {
						Ext.MessageBox.alert("Error", "Failed to fetch vector data (drawing: {{ drawing_id }})");
					}
				});
					{% endfor %}
				geojson_links.setLinks(drawings_links);
				{% endif %}

				{% include "viewer/permalink.js" %}
			}; // end of main function

			Ext.QuickTips.init();
			Ext.onReady(main);
		</script>
	</head>
	<body>
		<div id="overviewLegend" style="margin-left:10px"></div>
		<div id="dpiDetection"></div>
	</body>
</html>
