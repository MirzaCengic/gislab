#!/bin/bash

set -e

source $GISLAB_ROOT/functions.sh


# require root privileges
gislab_require_root


# usage
function usage() {
	echo "USAGE: $(basename $0) [OPTIONS]"
	echo "Print important runtime GIS.lab server logs in real time."
	echo "Hit [CTRL-C] to exit!"
	echo -e "\nOPTIONS
	-n  number of lines to display from each log file on start (default 1)
	-A  print all logs (default)
	-a  print authentication logs (include logs from GIS.lab clients)
	-b  print dns service logs
	-i  print dhcp service logs
	-e  print email service logs
	-l  print ldap service logs
	-d  print database service logs
	-m  print mapserver service logs (include error logs from load-balancer servers)
	-w  print web services error logs
	-W  print web services access and error logs
	-c  print chat service logs 
	-h  display this help
	"
	exit 255
}


# options
LOGLINES=1
while getopts "n:AabieldmwWch" OPTION
do
        case "$OPTION" in
			n) LOGLINES="$OPTARG" ;;
			A) ALL="yes" ;;
			a) AUTH="yes";;
			b) DNS="yes" ;;
			i) DHCP="yes" ;;
			e) EMAIL="yes" ;;
			l) LDAP="yes" ;;
			d) DATABASE="yes" ;;
			m) MAPSERVER="yes" ;;
			w) WEB="yes" ;;
			W) WEB="yes"
			   WEB_ACCESS="yes" ;;
			c) CHAT="yes" ;;
			h) usage ;;
			\?) exit 1 ;;
        esac
done
shift $(($OPTIND - 1))


if [ "$ALL" == "yes" \
  -o "$AUTH" != "yes" \
  -a "$DNS" != "yes" \
  -a "$DHCP" != "yes" \
  -a "$EMAIL" != "yes" \
  -a "$LDAP" != "yes" \
  -a "$DATABASE" != "yes" \
  -a "$MAPSERVER" != "yes" \
  -a "$WEB" != "yes" \
  -a "$WEB_ACCESS" != "yes" \
  -a "$CHAT" != "yes" ]; then
	AUTH="yes"
	DNS="yes"
	DHCP="yes"
	EMAIL="yes"
	LDAP="yes"
	DATABASE="yes"
	MAPSERVER="yes"
	WEB="yes"
	WEB_ACCESS="yes"
	CHAT="yes"
fi

tail_cmd="tail -n $LOGLINES"

# kill all background processes on exit
trap 'kill $(jobs -p); echo' EXIT

if [ "$AUTH" == "yes" ]; then
	$tail_cmd -f /var/log/auth.log &
fi

if [ "$DNS" == "yes" ]; then
	$tail_cmd -f /var/log/syslog | grep -E ' named\[[0-9]+\]:' &
fi

if [ "$DHCP" == "yes" ]; then
	$tail_cmd -f /var/log/syslog | grep -E ' dhcpd:' &
fi

if [ "$EMAIL" == "yes" ]; then
	$tail_cmd -f /var/log/syslog | grep -E ' postfix/[a-z]+\[[0-9]+\]:| postmulti\[[0-9]+\]:' &
fi

if [ "$LDAP" == "yes" ]; then
	$tail_cmd -f /var/log/syslog | grep -E ' slapd\[[0-9]+\]:' &
fi

if [ "$DATABASE" == "yes" ]; then
	if [ "$GISLAB_DEBUG_SERVICES" == "no" ]; then
		$tail_cmd -f /var/log/postgresql/postgresql-error.log &
	else
		$tail_cmd -f /var/log/postgresql/postgresql-debug.log &
	fi
fi

if [ "$MAPSERVER" == "yes" ]; then
	$tail_cmd -f /var/log/syslog | grep ' apache-mapserver:' &
	$tail_cmd -f /var/log/apache2/mapserver-access.log &
fi

if [ "$WEB" == "yes" ]; then
	$tail_cmd -f /var/log/syslog | grep ' apache:\| apache-default:' &
	$tail_cmd -f /var/log/syslog | grep ' gunicorn\.webgis\.error:' &
	$tail_cmd -f /var/log/nginx/error.log -f /var/log/nginx/webgis-error.log &
fi

if [ "$WEB_ACCESS" == "yes" ]; then
	$tail_cmd -f /var/log/apache2/access.log -f /var/log/nginx/access.log -f /var/log/nginx/webgis-access.log &
fi

if [ "$CHAT" == "yes" ]; then
	$tail_cmd -f /var/log/ircd/ircd-hybrid.log &
fi

# wait for Ctrl+C
wait

# vim: set ts=4 sts=4 sw=4 noet:
