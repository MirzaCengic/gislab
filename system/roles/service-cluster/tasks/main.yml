---
#
### GIS.lab CLUSTER ###
#
# Install GIS.lab clustering support.
#
# Logging: /storage/log/syslog


- name: Install packages
  apt: pkg={{item}} force=yes install_recommends=no state=latest
  with_items:
    - unzip


- name: Install Serf
  shell: source {{ GISLAB_ROOT }}/system/functions.sh && gislab_serf_install 0.6.4
  args:
    executable: /bin/bash


- name: Generate encryption key (run only once)
  shell: echo -e "[\"$(serf keygen)\"]" > /etc/gislab/gislab_serf.key
    && chmod 600 /etc/gislab/gislab_serf.key
  args:
    executable: /bin/bash
    creates: /etc/gislab/gislab_serf.key


- name: Purge GIS.lab cluster installation directory
  file: dest={{ GISLAB_INSTALL_CLUSTER_ROOT }} state=absent

- name: Prepare directory for cluster installation
  file: path={{ GISLAB_INSTALL_CLUSTER_ROOT }}/handlers state=directory


- name: Prepare directory for cluster handlers
  file: path={{ GISLAB_INSTALL_CLUSTER_ROOT }}/handlers state=directory

- name: Install Serf handlers scripts 
  copy: src=static/serf/ dest={{ GISLAB_INSTALL_CLUSTER_ROOT }}/handlers mode=0774
  notify:
  - service serf-agent restart


- name: Install Serf agent init script
  template: src=init/serf-agent.conf.j2 dest=/etc/init/serf-agent.conf
  notify:
  - service serf-agent restart


- meta: flush_handlers

# vim:ft=ansible:
