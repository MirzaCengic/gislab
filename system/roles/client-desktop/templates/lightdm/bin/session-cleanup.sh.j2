#!/bin/bash
# LightDM session cleanup script. This script is run after a greeter or user session stops. It is run as root.

source /etc/gislab_version


# remove global session lock file after session is closed
rm -f /var/lib/gislab/session.lock

# remove user lock file after session is closed
rm -f /mnt/home/$USER/.gislab/session.lock

# remove session tag
serf tags -delete session-active


# restart machine if new client image is available
GISLAB_CLIENT_IMAGE_VERSION_SERVER=$(curl http://server.gis.lab/gislab_desktop.version)
GISLAB_CLIENT_IMAGE_VERSION_CLIENT=$(cat /etc/gislab_desktop.version)

if [ "$GISLAB_CLIENT_IMAGE_VERSION_SERVER" != "$GISLAB_CLIENT_IMAGE_VERSION_CLIENT" ]; then
	for i in $(seq 10 10 100); do
		echo $i;
		sleep 1;
	done | zenity --title=Info --progress \
			--text="A new version of the system is available, rebooting in 10s." \
			--auto-close --no-cancel
	/sbin/reboot
	exit 0
fi


# vim: set ts=4 sts=4 sw=4 noet:
